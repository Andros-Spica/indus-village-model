---
title: "Household Demography model"
output: html_notebook
---

## Figure 9. Example of response of the three life table models to parameter variation

Load functions that create/import Life Table models for fertility and nuptiality (Peristera-Kostaki model), and mortality (Coale-Demeny model):

```{r}
### fertility
# The following correspond to the first parametric model
# mentioned in page 147 of:
# # Peristeva and Kostaki, 2009
# "Modeling fertility in modern populations"
# Available from: https://dx.doi.org/10.4054/DemRes.2007.16.6

### nuptiality
# The following correspond to the first parametric model
# for fitting the age-specific distributions of marriages, mentioned in page 133 of:
# # Peristeva and Kostaki, 2015
# "A parametric model for estimating nuptiality patterns in modern populations"
# Available from: https://www.researchgate.net/publication/285457704_A_parametric_model_for_estimating_nuptiality_patterns_in_modern_populations [accessed Nov 27 2018].

# the equation is the same for both fertility and nuptiality.

generatePeristeraKostaki <- function(par.c1 = 0.8, par.mu = 25, par.sigma = c(10, 10) )
{
  curve <- c()
  for (i in 1:100)
  {
    sigma = par.sigma[1]
    if (i > par.mu)
    { sigma = par.sigma[2] }
    
    curve <- c(curve, par.c1 * exp (-1 * (((i - par.mu) / sigma) ^ 2)) )
  }
  
  return(curve)
}

### mortality
# from Coale-Demeny Model Life Tables generated with 'demoR' package
# demoR package version 0.6.0 (2018-09-13)
# by James Holland Jones and collaborators
# Their source:
# Coale, A., P. Demeny, and B. Vaughn. 1983. 
# Regional model life tables and stable populations. 
# 2nd ed. New York: Academic Press.

interpolatePerYear <- function(raw, ages = c(0.5, 1.5, 4, seq(8.5, 93.5, 5))) {
  
  perYear <- data.frame(matrix(numeric(0), nrow = 151, ncol = ncol(raw)))
  names(perYear) <- 1:ncol(perYear)
  
  for (i in 1:ncol(raw)) {
    perYear[, i] <- approx(ages, raw[, i], 
                           xout = 1:151, yleft = 0, yright = 1)$y
  }
  row.names(perYear) <- 0:150
  
  return(perYear)
}

generateCoaleDemenyLifeTable <- function(region = "north", sex = "F", level = 8){
  
  curve <- 0
  
  if (region == "north")
  {
    curve <- interpolatePerYear(t(demogR::cdmltn(sex = sex)$nqx))[,level]
  }
  if (region == "west")
  {
    curve <- interpolatePerYear(t(demogR::cdmltw(sex = sex)$nqx))[,level]
  }
  if (region == "east")
  {
    curve <- interpolatePerYear(t(demogR::cdmlte(sex = sex)$nqx))[,level]
  }
  if (region == "south")
  {
    curve <- interpolatePerYear(t(demogR::cdmlts(sex = sex)$nqx))[,level]
  }
  
  return(curve)
}
```

Plot the curves generated by small explorations of the parameter space of each model: 

```{r}
#--------
# To create a png file:
plotName = "Fig9.png"

grScale = 2

png(plotName, width = grScale * 600, height = grScale * 600)
#---------
# alternatively, to create eps file:
# plotName = "Fig9.eps"
# 
# grScale = 1.8
# 
# extrafont::loadfonts(device = "postscript")
# grDevices::postscript(file = plotName,
#                       pointsize = 10,
#                       width = grScale * 6,
#                       height = grScale * 6,
#                       horizontal = FALSE,
#                       paper = "special",
#                       onefile = FALSE,
#                       family = "sans",
#                       colormodel = "cmyk")
#---------

layout(matrix(1:2, nrow = 2, ncol = 1))

par(cex = grScale * 1.2, family = "sans",
    mar = c(3.5, 4.1, 1.1, 0.2))

# 1. Peristera-Kostaki equation (Fertility and Nuptiality models)

plot(c(1, 100), c(0, 1), type = "n", 
     main = "Peristera-Kostaki equation",
     xlab = "AGE\n",
     ylab = ""
)
mtext(text = "Probability of event\n(giving birth, marrying)", 
      side = 2, line = 2, cex = grScale * 1.2)

# five variations of parameter settings
parValues <- rbind(
  c(0.8, 25, 10, 10),
  c(0.95, 20, 5, 7),
  c(0.7, 25, 12, 15),
  c(0.85, 18, 2, 15),
  c(0.75, 22, 8, 10)
)

for (i in 1:nrow(parValues))
{
  lines(1:100, 
        generatePeristeraKostaki(par.c1 = parValues[i, 1], par.mu = parValues[i, 2], 
                                 par.sigma = c(parValues[i, 3], parValues[i, 4])), 
        col = i, lwd = grScale * 3)
  
  legend(60, 1 - 0.1 * (i - 1), 
       legend = substitute(paste(c[1], " = ", pc1, ", ", mu, " = ", pmu, ", ",
                                 sigma[1], " = ", ps1, ", ", sigma[2], " = ", ps2), 
                           list(pc1 = parValues[i, 1], pmu = parValues[i, 2],
                                ps1 = parValues[i, 3], ps2 = parValues[i, 4])), 
       col = i,
       lwd = grScale * 3, cex = 0.8,
       title = NULL, bty = "n")
}

# 2. Mortality model (CoaleDemeny Life tables)

plot(c(1, 151), c(0, 1), type = "n", 
     main = "Coale-Demeny Model Life Tables",
     xlab = "AGE\n",
     ylab = "Probability of dying",
     xlim = c(0, 100)
)

# five variations of parameter settings
parValues <- rbind(
  c("north", "M", 1),
  c("west", "F", 8),
  c("east", "M", 12),
  c("south", "F", 17),
  c("north", "F", 25)
)

for (i in 1:nrow(parValues))
{
  lines(1:151, 
        generateCoaleDemenyLifeTable(region = parValues[i, 1], 
                                     sex = parValues[i, 2], 
                                     level = parValues[i, 3]), 
        col = i, lwd = grScale * 3)
  
  legend(1, 1 - 0.1 * (i - 1), 
       legend = paste("region = ", parValues[i, 1], ", ", 
                      "sex = ", parValues[i, 2], ", ",
                      "level = ", parValues[i, 3]),
       col = i, text.font = 3,
       lwd = grScale * 3, cex = 0.8,
       title = NULL, bty = "n")
}

dev.off()
```

```{r, out.width = "\\textwidth"}
knitr::include_graphics(plotName)
```


## loading simulation data

```{r}
endStates <- read.csv("output/3-householdDemography v.1.1 - kinship tabu for new couples exp-endstates-table.csv", skip = 6)
```

## Survival of populations

```{r}
hist(endStates$totalIndividuals)
```

### Initial household population

This parameter has slight positive effect on population survival:

```{r}
summary(endStates$initialNumHouseholds[endStates$totalIndividuals == 0])
summary(endStates$initialNumHouseholds[endStates$totalIndividuals > 0])
```

```{r}
boxplot(endStates$initialNumHouseholds ~ (endStates$totalIndividuals > 0))
```

### Mortality factors

Coale-Demeny Life Tables Model level parameter has great effect:

```{r}
summary(endStates$cdmlt.level[endStates$totalIndividuals == 0])
summary(endStates$cdmlt.level[endStates$totalIndividuals > 0])
```

```{r}
boxplot(endStates$cdmlt.level ~ (endStates$totalIndividuals > 0))
```

but region parameter has a smaller effect. East tends to survive more often.  

```{r}
table(endStates$coale.demeny.region, endStates$totalIndividuals > 0)
```

```{r}
boxplot(data = endStates, totalIndividuals ~ coale.demeny.region)
```

### Fertility factors

All have a visible effect, but particularly c1.fert and sigma1.fert. 

```{r}
layout(matrix(1:4, nrow = 2, byrow = T))
boxplot(endStates$c1.fert ~ (endStates$totalIndividuals > 0), main = "c1.fert")
boxplot(endStates$mu.fert ~ (endStates$totalIndividuals > 0), main = "mu.fert")
boxplot(endStates$sigma1.fert ~ (endStates$totalIndividuals > 0), main = "sigma1.fert")
boxplot(endStates$sigma2.fert ~ (endStates$totalIndividuals > 0), main = "sigma2.fert")
```

### Nuptiality factors

Residential rule showing no clear effect:

```{r}
table(endStates$residence.rule, endStates$totalIndividuals > 0)
```

The effect of the acceptable kinship degree is also unclear: 

```{r}
boxplot(endStates$acceptable.kinship.degree.for.couples ~ (endStates$totalIndividuals > 0))
```

All nuptiality parameters for both men and women present a small, yet apparently consistent effect. c1 and sigma parameters have a positive effect while mu has a smaller negative effect.

```{r}
layout(matrix(1:8, nrow = 2, byrow = T))
boxplot(endStates$c1.women ~ (endStates$totalIndividuals > 0), main = "c1.women")
boxplot(endStates$mu.women ~ (endStates$totalIndividuals > 0), main = "mu.women")
boxplot(endStates$sigma1.women ~ (endStates$totalIndividuals > 0), main = "sigma1.women")
boxplot(endStates$sigma2.women ~ (endStates$totalIndividuals > 0), main = "sigma2.women")
boxplot(endStates$c1.men ~ (endStates$totalIndividuals > 0), main = "c1.men")
boxplot(endStates$mu.men ~ (endStates$totalIndividuals > 0), main = "mu.men")
boxplot(endStates$sigma1.men ~ (endStates$totalIndividuals > 0), main = "sigma1.men")
boxplot(endStates$sigma2.men ~ (endStates$totalIndividuals > 0), main = "sigma2.men")
```

## Timing of survival

```{r}
hist(endStates$X.step.)
```

```{r}
table(endStates$X.step. > 0)
```

```{r}
plot(endStates$initialNumHouseholds ~ endStates$X.step.)
```


