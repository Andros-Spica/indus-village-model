---
title: "Demostration of the Weather model"
author: "Andreas Angourakis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    number_sections: yes
  pdf_document: default
---

# Load source file

```{r}
source("source/weatherModel.R")
```

## Base generic functions

### Sinusoidal curve with fluctuations

Generic function for geting points in sinusoidal curves depending on minValue, maxValue, length of year in days, and a normal stochastic fluctuation. See extended explanation at [HTML with R walkthrough](https://htmlpreview.github.io/?https://github.com/Andros-Spica/indus-village-model/blob/master/01-weather/documentation/annualSinusoidCurve.html).

```{r}
getDayValueInAnnualSinusoidWithFluctuation
```
```{r}
getDayValueInAnnualSinusoid
```

### Annual cumulative daily precipitation using escalonated double logistic curve

Declare generic function for geting an year of daily precipitation. First, it generates a double logistic curve of range 0-1 depending on start and end days of year, a plateau value (intermediate value), and two sets of point of inflection and growth rate. See extended explanation at [HTML with R walkthrough](https://htmlpreview.github.io/?https://github.com/Andros-Spica/indus-village-model/blob/master/01-weather/documentation/doubleLogisticCurve.html). Then, the curve is broken down stochastically into steps, controlled by `nSample` and `maxSampleSize`, which better represents the discretionality of precipitation events. Finally, the cumulative daily value is transformed into daily increments, which is multiplied by the annualSum, returning daily precipitation values. 

```{r}
getPrecipitationOfYear
```

```{r}
doubleLogisticCurve
```

```{r}
doubleLogistic
```

```{r}
escalonateCurve
```

```{r}
getIncrementsFromCumulativeCurve
```

### Reference evapotranspiration

```{r}
estimateETr
```

## Auxiliar functions

An auxiliar function to simplify code with long variable names:

```{r}
getLastItemInVector
```

Function for marking the end of each year:

```{r}
markEndYears
```

## The model main procedures

```{r}
weatherModel.init
```

```{r}
weatherModel.run
```

# Running the model

## Initialise

```{r}
weatherModel <- weatherModel.init()
```

Show table with parameter values:

```{r}
parvalues <- c(
  weatherModel$PARS[[1]],
  weatherModel$PARS[[2]]
)
parNames <- c("yearLengthInDays", "albedo")

for (j in 3:length(weatherModel$PARS))
{
  parGroupName <- names(weatherModel$PARS)[j]
  for (i in 1:length(weatherModel$PARS[[j]]))
  {
    parvalues <- c(
      parvalues,
      weatherModel$PARS[[j]][[i]]
    )
    parName <- paste(parGroupName, names(weatherModel$PARS[[j]])[i], sep = " - ")
    parNames <- c(parNames, parName)
  }
}

parvalues <- cbind(parNames, parvalues)
knitr::kable(parvalues, 
             format = "html",
             col.names = c("parameter", "values"),
             align = c("l", "r"))
```

## Run

Run for 5 years:

```{r}
weatherModel <- weatherModel.run(weatherModel, 5)
```

Plot time-series:

```{r}
lengthOfSimulation = length(weatherModel$daily$currentYear)

#--------
# To create a png file:
plotName = "weatherModelExample.png"

fontScale = c(2, 2, 1.2, # c(cex.lab, legend, cex.axis)
              3, 2) # side annotation name and "model"

png(plotName, width = 1000, height = 800)

layout(matrix(c(1:4), nrow = 4), heights = c(10, 10, 10, 12))

yLabs <- c(expression(paste("    Solar\nRadiation (", MJ/m^-2, ")")), 
           "Temperature (ÂºC)", 
           "Precipitation (mm)", 
           "ETr (mm)")
leftMargin <- 7


# 1. Solar radiation
par(mar = c(0.1, leftMargin, 1.1, 0.2), 
    cex.lab = fontScale[1],
    cex.axis = fontScale[3])

plot(1:lengthOfSimulation, weatherModel$daily$solarRadiation, type = "l",
     xlab = "", xaxt = 'n',
     ylab = yLabs[1])
markEndYears(lengthOfSimulation)

# 2. Temperature
plot(1:lengthOfSimulation, weatherModel$daily$temperature, type = "l",
     xlab = "", xaxt = 'n',
     ylab = yLabs[2])
lines(1:lengthOfSimulation, weatherModel$daily$temperature_max, col = "red")
lines(1:lengthOfSimulation, weatherModel$daily$temperature_min, col = "blue")

markEndYears(lengthOfSimulation)

# 3. Reference evapotranspiration

plot(1:lengthOfSimulation, weatherModel$daily$ETr, type = "l",
     ylab = yLabs[4],
     xlab = "", xaxt = 'n')
markEndYears(lengthOfSimulation)

# 4. Precipitation
par(mar = c(5, leftMargin, 1.1, 0.2))

barplot(weatherModel$daily$precipitation, 
        ylab = yLabs[3],
        names.arg = 1:lengthOfSimulation,
        xlab = "day")
markEndYears(lengthOfSimulation, offset = 1.2) ; abline(v = 2190 * 1.2, lty = 3)
# not sure why, but barplot() x coordinates do not behave as in plot()

dev.off()
```

```{r, out.width = "\\textwidth"}
knitr::include_graphics(plotName)
```

