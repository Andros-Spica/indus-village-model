This integrated version combines the Weather, Soil Water, and Land models into a spatially-distributed land model.

[[https://github.com/Andros-Spica/indus-village-model/blob/master/diagrams/I1-LandWaterModel_00-in-OverallDesign.png | alt=Land Water model in overall design]]

The integration of the Weather and Soil Water models was a straightforward task because the former was specifically designed to generate inputs for the latter (and the Crop model). Thus, this was solved already during the development of the Soil Water model, as it was implemented in NetLogo.

The challenge posed by the Integrated Land Water model was the integration of the Land model with the already consolidated (Weather-)Soil Water model. The Land model generates static terrain data (i.e., `elevation`, `flow_direction`, `flow_accumulation`, soil properties, ecological community composition, cover type) while the Soil Water model describes a dynamic process (i.e. the passing of water) within each land unit separately. Most inputs generated by the Land model used in the Soil Water model are simple spatially distributed variables, usable as-is (i.e. run-off curve number and soil water properties). However, there are several key aspects that are not specified enough in either of these models and, thus, required further design in this integrated model: 

* estimation of soil water capacity thresholds according to soil texture   
* run-off exchange  
* inundation exchange  
* ecological impact of water or how the state of surface and soil water affects the ecological community in a land unit, once it has been initialised by the Land model.

## Linear estimation of soil water capacity horizons

As a temporary measure, we estimate wilting point and saturation horizons (fraction of soil volume), for the single soil layer, using linear models factoring only percent of clay.

[[https://github.com/Andros-Spica/indus-village-model/blob/master/00-integrated-models/documentation/linearEstimationOfSoilWaterHorizons.png | alt=linear estimation of soil water wilting and saturation points]]

[Link to file](https://github.com/Andros-Spica/indus-village-model/blob/master/00-integrated-models/documentation/linearEstimationOfSoilWaterHorizons.png)

[HTML with R source code](https://htmlpreview.github.io/?https://github.com/Andros-Spica/indus-village-model/blob/master/00-integrated-models/documentation/linearEstimationOfSoilWaterHorizons.html)

Data on soil water properties:

>Unknown Author, 1987, USDA Textural Classification Study Guide, United States Department of Agriculture, Soil Mechanics Level 1, Module 3.

>Cronshey R G 1986 Urban Hydrology for Small Watersheds, Technical Release 55 (TR-55). 
United States Department of Agriculture, Soil Conservation Service, Engineering Division. 
Table in page A-1 (hydrologic soil groups) and table 2.2 (run off curve number).

>Plant & Soil Sciences eLibrary, Lesson: Soils - Part 2: Physical Properties of Soil and Soil Water, page 10 (Soil Water), Table 2.6. https://passel2.unl.edu/view/lesson/0cff7943f577/10

>Rain Machine support documentation, "Zones", "Soil Types", Table. https://support.rainmachine.com/hc/en-us/articles/228001248-Soil-Types

>SWAT theoretical documentation 2009, p. 148, Table 2:3-1, https://swat.tamu.edu/media/99192/swat2009-theory.pdf

## Run-off exchange

The run-off exchange algorithm combines the Soil Water model with the design of two algorithms: **(a)** one that handles the order of the pairwise exchange between land units (i.e. flow accumulation), and **(b)** another for calculating the run-off exchanged at every instance.

The algorithm handling the order of run-off exchange **(a)** is already fully implemented in the Land model to calculate `flow_accumulation` using `elevation`, and it is based on: 

>Jenson, S. K., & Domingue, J. O. (1988). Extracting topographic structure from digital elevation data for geographic information system analysis. Photogrammetric engineering and remote sensing, 54(11), 1593-1600.

The specific fragment explaining the algorithm is the following:

>"FLOW ACCUMULATION DATA SET

>The third procedure of the conditioning phase makes use of the flow direction data set to create the flow accumulation data set, where each cell is assigned a value equal to the number of cells that flow to it (O’Callaghan and Mark, 1984). Cells having a flow accumulation value of zero (to which no other cells flow) generally correspond to the pattern of ridges. Because all cells in a depressionless DEM have a path to the data set edge, the pattern formed by highlighting cells with values higher than some threshold delineates a fully connected drainage network. As the threshold value is increased, the density of the drainage network decreases. The flow accumulation data set that was calculated for the numeric example is shown in Table 2d, and the visual example is shown in Plate 1c." (p. 1594)

See [HTML with R walkthrough](https://htmlpreview.github.io/?https://github.com/Andros-Spica/indus-village-model/blob/master/03-land-model/documentation/flowAccumulationOrder.html) explaining this algorithm.

The algorithm calculating the run-off effectively moving from one land unit to another **(b)** is a simplification of the one found on:

>Yang L. E., Scheffran J., Süsser D., Dawson R. and Chen Y. D. (2018) Assessment of Flood Losses with Household Responses: Agent-Based Simulation in an Urban Catchment Area Environ. Model. Assess. 23 369–88. http://link.springer.com/10.1007/s10666-018-9597-3

See [HTML with R walkthrough](https://htmlpreview.github.io/?https://github.com/Andros-Spica/indus-village-model/blob/master/00-integrated-models/documentation/runoffExchange.html) explaining this algorithm.

## Inundation exchange

After the introduction of river water flow (and seawater, if there are elevations are below sea level) and also solving run-off exchanges, it is possible that some patches down the stream hold enough surface water for them to be higher than neighbours, in terms of elevation plus average surface water depth. This will happen specially when the value assigned to `riverWaterPerFlowAccumulation` is relatively high (much greater than 1E-4 mm / flow accumulation units). High values of flow_riverAccumulationAtStart used in the land model to generate the terrain will also make this situation more frequent. 

The inundation exchange algorithm redistributes the excess of surface water in each land unit with such excess to their lowest neighbours, in terms of elevation plus surface water depth. To do that, for each land unit with excess, the surface water of the entire Moore neighbourhood is aggregated, divided into arbitrarily small parts, which are added to the current lowest land unit within the neighbourhood, including the central land unit. The small parts’ dimension (`errorToleranceThreshold`) serves also has a threshold criterium, below which differences between land unit heights are deemed negligible. The inundation exchange algorithm is also based on Yang et al. 2018 (see above).

See [HTML with R walkthrough](https://htmlpreview.github.io/?https://github.com/Andros-Spica/indus-village-model/blob/master/00-integrated-models/documentation/inundationExchange.html) explaining this algorithm.

## Surface water and ecological communities

When water input exceeds the capacity of the soil, surface water accumulates as an additional type of ecological component. Given a volume of surface water (mm/m^2), the percentage of land unit area (1 ha or 10,000 m^2) covered by water is estimated assuming a bankfull width/depth ratio of 12 for all land units and a bankfull width equal or less than land unit width (100 m). The width/depth ratio of 12 has been empirically identified as the most common value universally, and is a consequence of the physical processes governing the distribution of energy and resultant sediment transport (Rosgen and Silvey 1996). 

The solution derivation is as follows:

`ratio = width (m) / (p_water (mm) / 1000)`  
`width = ratio * p_water / 1000`  
`water% = min (list (100 * width / patchWidth) 100)`  

therefore, the NetLogo code in `get-%water-surface [ water ]` (lines 1459-1477):

```
let waterWidth 12 * water / 1000  
report clampMinMax (100 * waterWidth / patchWidth) 0 100 ;;; where clampMinMax [value minimum maximum]
```

The expansion of water surface is at the expense of dry ecological components (i.e., grass, brush, and wood), which are assumed to be affected evenly. When dry land is available, all ecological components grow following a logistic growth model, where the carrying capacity is proportional to the value in the initial ecological community configuration (given by the Land model), minus the influence of water stress (i.e. ARID multiplied by water stress sensitivity). The intrinsic reproductive rate (growth slope) and water stress sensitivity are controlled as parameters found in the "ecological CommunitiesTable.csv".

>Rosgen, D.L., and H.L. Silvey. Applied River Morphology. Fort Collins, CO: Wildland Hydrology Books, 1996.

Definition of river stage in:

>https://www.usgs.gov/special-topic/water-science-school/science/water-qa-what-does-term-river-stage-mean?qt-science_center_objects=0#qt-science_center_objects

>https://www.fondriest.com/environmental-measurements/measurements/hydrological-measurements/streamflow-measurements/

About river width/depth ratio:

>https://cfpub.epa.gov/watertrain/moduleFrame.cfm?parent_object_id=1262#:~:text=The%20width%2Fdepth%20(W%2F,the%20channel%20to%20move%20sediment

About stream types:

>https://cfpub.epa.gov/watertrain/moduleFrame.cfm?parent_object_id=1199

[[https://github.com/Andros-Spica/indus-village-model/blob/master/diagrams/I1-LandWaterModel.png | alt=Land Water model]]

[Link to file](https://github.com/Andros-Spica/indus-village-model/blob/master/diagrams/I1-LandWaterModel.png)

[[https://github.com/Andros-Spica/indus-village-model/blob/master/screenshots/I1-integrated-land-water%20interface.png | alt=Land Water model interface]]

[Link to file](https://github.com/Andros-Spica/indus-village-model/blob/master/screenshots/I1-integrated-land-water%20interface.png)

